<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Satchel</title>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <style>
      html, body {
        background-color: #222222;
        color: #ffffff;
        text-align: center;
      }
      h1 {
        font-size: 3em;
      }
    </style>
  </head>
  <body>
    <style>
      .container {
        display: flex;
      }
      .spacing {
        flex: 1;
      }

      nav {
        display: flex;
        flex-direction: column;
      }
      nav button {
        font-size: 1.2em;
        cursor: pointer;
      }
      nav > * {
        margin: 0.5em 0;
      }
      nav p {
        opacity: 0.6;
      }

      #logo {
        width: 10em;
        margin: 2em;
      }
      
      #buttonIntro {
        background: none;
        border: none;
        color: #ffffff;
      }
      #buttonIntro:hover {
        color: #aaaaaa;
      }
    </style>
    <h1>Satchel</h1>
    <img id="logo" src="res/images/potion.png">
    <div class="container">
      <div class="spacing"></div>
      <nav>
        <button id="buttonIntro">Getting Started</button>
        <button id="buttonStart">Start Session</button>
        <button id="buttonJoin">Join Session</button>
        <p>Alpha <span id="appVersion">v-.-.-</span></p>
      </nav>
      <div class="spacing"></div>
    </div>
    <style>
      dialog {
        margin: 0;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
      }
      #backdrop {
        visibility: visible;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      #backdrop.hidden {
        visibility: hidden;
      }
    </style>
    <dialog>
      <form id="sessionForm" autocomplete="off">
        <p>Your Invitation?</p>
        <p>
          <input type="text" name="id" id="sessionId" placeholder="Session Id" required pattern="[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}">
          <button id="sessionPaste">Paste</button>
        </p>
        <p>
          <input type="submit" id="sessionJoin" value="Join">
          <button id="sessionCancel">Cancel</button>
        </p>
      </form>
    </dialog>
    <div id="backdrop" class="hidden"></div>
    <script type="module">
      import { BUILD_VERSION } from './src/globals.js';
      import { pasteFromClipboard } from './src/util/clipboard.js';
      import { uuid } from './src/util/uuid.js';

      window.addEventListener('DOMContentLoaded', () => {
        document.querySelector('#buttonStart').addEventListener('click', () => {
          window.open(`./app.html`, '_parent');
        });
        document.querySelector('#buttonJoin').addEventListener('click', () => {
          document.querySelector('dialog').toggleAttribute('open', true);
          document.querySelector('#backdrop').classList.toggle('hidden', false);
        });
        document.querySelector('#appVersion').textContent = `v${BUILD_VERSION}`;
        document.querySelector('#backdrop').addEventListener('click', () => {
          document.querySelector('dialog').toggleAttribute('open', false);
          document.querySelector('#backdrop').classList.toggle('hidden', true);
        });
        document.querySelector('#sessionPaste').addEventListener('click', async (e) => {
          const text = await pasteFromClipboard();
          const uuidPattern = /[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/;
          const result = uuidPattern.exec(text);
          const sessionId = document.querySelector('#sessionId');
          if (result) {
            sessionId.value = result[0];
          } else {
            sessionId.value = text;
          }
          return false;
        });
        document.querySelector('#sessionCancel').addEventListener('click', async (e) => {
          document.querySelector('#backdrop').click();
          e.preventDefault();
          e.stopPropagation();
          return false;
        });
        document.querySelector('#sessionForm').addEventListener('submit', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const formData = new FormData(e.target);
          const id = formData.get('id');
          window.open(`./app.html?id=${id}`, '_parent');
          return false;
        });
      });
    </script>
  </body>
</html>
